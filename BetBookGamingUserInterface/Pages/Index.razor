@page "/"
@inject ILogger<Index> logger
@inject IMongoUserData userData
@inject IMongoSingleBetData sb
@inject IGameService gameService

<PageTitle>Home</PageTitle>

@if(!isBusy)
{
    <FootballSpinners />

    @*<div id="scrollBox" class="scroll-box">
        <div class="pulsating-circle"></div>
        <img class="scroll-img" src="/images/arrowdown.png"/>
    </div>*@
    <div id="scrollBox" class="scroll-box">
        <div class="arrow bounce">
        </div>
    </div>
   
    
    <div id="scrollBoxWeek">
        <h2 id="weekText">Week @week</h2>
    </div>

    
    
        
    <div id="hiddenContent">
        <GamesDisplay Games="games" />
    </div>

    <div class="b-slip">
        <AccordionBetSlip OnValidSubmit="@ShowToast" LoggedInUser="loggedInUser" />
    </div>
}

else 
{
    <LoadingSpinnerCircle />
}

<SfToast @ref="ToastObj" Timeout="@time" ShowCloseButton="true" 
    Title="Good Luck On Your New Wager!" Content="@Content">
    <ToastPosition X="Right" Y="Bottom"></ToastPosition>
    <ToastAnimationSettings>
        <ToastShowAnimationSettings Effect="@ShowAnimation" />
        <ToastHideAnimationSettings Effect="@HideAnimation" />
    </ToastAnimationSettings>
</SfToast>

<style>

    .arrow {
  width: 100px;
  height: 100px;
  background-image: url(data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4NCjwhLS0gR2VuZXJhdG9yOiBBZG9iZSBJbGx1c3RyYXRvciAxNi4wLjAsIFNWRyBFeHBvcnQgUGx1Zy1JbiAuIFNWRyBWZXJzaW9uOiA2LjAwIEJ1aWxkIDApICAtLT4NCjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+DQo8c3ZnIHZlcnNpb249IjEuMSIgaWQ9IkxheWVyXzEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHg9IjBweCIgeT0iMHB4IiB3aWR0aD0iNTEycHgiIGhlaWdodD0iNTEycHgiIHZpZXdCb3g9IjAgMCA1MTIgNTEyIiBlbmFibGUtYmFja2dyb3VuZD0ibmV3IDAgMCA1MTIgNTEyIiB4bWw6c3BhY2U9InByZXNlcnZlIj4NCjxwYXRoIGZpbGw9IiNGRkZGRkYiIGQ9Ik0yOTMuNzUxLDQ1NS44NjhjLTIwLjE4MSwyMC4xNzktNTMuMTY1LDE5LjkxMy03My42NzMtMC41OTVsMCwwYy0yMC41MDgtMjAuNTA4LTIwLjc3My01My40OTMtMC41OTQtNzMuNjcyICBsMTg5Ljk5OS0xOTBjMjAuMTc4LTIwLjE3OCw1My4xNjQtMTkuOTEzLDczLjY3MiwwLjU5NWwwLDBjMjAuNTA4LDIwLjUwOSwyMC43NzIsNTMuNDkyLDAuNTk1LDczLjY3MUwyOTMuNzUxLDQ1NS44Njh6Ii8+DQo8cGF0aCBmaWxsPSIjRkZGRkZGIiBkPSJNMjIwLjI0OSw0NTUuODY4YzIwLjE4LDIwLjE3OSw1My4xNjQsMTkuOTEzLDczLjY3Mi0wLjU5NWwwLDBjMjAuNTA5LTIwLjUwOCwyMC43NzQtNTMuNDkzLDAuNTk2LTczLjY3MiAgbC0xOTAtMTkwYy0yMC4xNzgtMjAuMTc4LTUzLjE2NC0xOS45MTMtNzMuNjcxLDAuNTk1bDAsMGMtMjAuNTA4LDIwLjUwOS0yMC43NzIsNTMuNDkyLTAuNTk1LDczLjY3MUwyMjAuMjQ5LDQ1NS44Njh6Ii8+DQo8L3N2Zz4=);
  background-size: contain;
  
}

.bounce {
    -webkit-animation: bounce 2s infinite;
    animation: bounce 2s infinite;
}

/* Scroll down indicator (bouncing) */
@@-webkit-keyframes bounce {
  0%, 20%, 50%, 80%, 100% {
    -webkit-transform: translateY(0); }
  40% {
    -webkit-transform: translateY(-30px); }
  60% {
    -webkit-transform: translateY(-15px); } }
@@-moz-keyframes bounce {
  0%, 20%, 50%, 80%, 100% {
    -moz-transform: translateY(0); }
  40% {
    -moz-transform: translateY(-30px); }
  60% {
    -moz-transform: translateY(-15px); } }
@@keyframes bounce {
  0%, 20%, 50%, 80%, 100% {
    -webkit-transform: translateY(0);
    -moz-transform: translateY(0);
    -ms-transform: translateY(0);
    -o-transform: translateY(0);
    transform: translateY(0); }
  40% {
    -webkit-transform: translateY(-30px);
    -moz-transform: translateY(-30px);
    -ms-transform: translateY(-30px);
    -o-transform: translateY(-30px);
    transform: translateY(-30px); }
  60% {
    -webkit-transform: translateY(-15px);
    -moz-transform: translateY(-15px);
    -ms-transform: translateY(-15px);
    -o-transform: translateY(-15px);
    transform: translateY(-15px); } }

    .scroll-box {
        background-color: rgb(0,0,0);
        background-color: rgba(0,0,0, 0.5);
        backdrop-filter: blur(10px);
        border: none;
        box-shadow: 5px 5px 5px rgba(0,0, 0);
        text-align: center;
        width: fit-content;
        margin: 0 auto;
        margin-top: 10em;
        margin-bottom: 4em;
        padding: .25em;
        border-radius: 10px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        opacity: 1;
    }

 
/*
    @@-webkit-keyframes pulse-ring {
  0% {
    transform: scale(0.33);
  }
  80%, 100% {
    opacity: 0;
  }
}
 
@@keyframes pulse-ring {
  0% {
    transform: scale(0.33);
  }
  80%, 100% {
    opacity: 0;
  }
}
@@-webkit-keyframes pulse-dot {
  0% {
    transform: scale(0.8);
  }
  50% {
    transform: scale(1);
  }
  100% {
    transform: scale(0.8);
  }
}
@@keyframes pulse-dot {
  0% {
    transform: scale(0.8);
  }
  50% {
    transform: scale(1);
  }
  100% {
    transform: scale(0.8);
  }
}*/

/*    .pulsating-circle:after {
        opacity: .4;
          content: "";
          position: absolute;
          left: 0;
          top: 0;
          display: block;
          width: 100%;
          height: 100%;
        background-color: #01a4e9;
          border-radius: 10px;
          box-shadow: 0 0 8px rgba(0, 0, 0, 0.3);
          -webkit-animation: pulse-dot 1.25s cubic-bezier(0.455, 0.03, 0.515, 0.955) -0.4s infinite;
          animation: pulse-dot 1.25s cubic-bezier(0.455, 0.03, 0.515, 0.955) -0.4s infinite;
    }

    .pulsating-circle:before {
          content: "";
          position: relative;
          display: block;
          width: 300%;
          height: 300%;
          box-sizing: border-box;
          margin-left: -100%;
          margin-top: -100%;
          border-radius: 10px;
          background-color: #01a4e9;
          -webkit-animation: pulse-ring 1.25s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
          animation: pulse-ring 1.25s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
    }

    .pulsating-circle {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translateX(-50%) translateY(-50%);
        width: 30px;
        height: 30px;
        border-color: transparent;
    }*/

    #weekText {
        font-family: 'Pacifico', cursive;
        position: relative;
        font-size:4em;
        color: #fff;
        text-transform:uppercase;
        width:100%;
        text-align:center;
        -webkit-box-reflect: below 1.5px linear-gradient(transparent, rgba(0,0,0,0.5));
        line-height:.70em;
        outline:none;
        animation: animateWeekText 10s linear infinite;
    }

    @@keyframes animateWeekText {
        0%,18%,20%,50.1%,60%,65.1%,80%,90.1%,92% {
            color: #380474;
            box-shadow: none;
        }
        18.1%,20.1%,30%,50%,60.1%,65%,80.1%,90%,92.1%,100% {
            color: #fff	;
                text-shadow: 0 0 10px #380474, 0 0 20px #380474, 0 0 40px #380474, 0 0 80px #380474, 0 0 160px #380474;
        }
    }

    @@media(max-width: 560px) {
        #weekText {
            font-size: 3em;
        }
    }

    @@media(max-width: 440px) {
        #weekText {
            font-size: 2.35em;
        }
    }

    #scrollBoxWeek {
        position: center;
        opacity: 0;
        margin: 0 auto;
        margin-bottom: 4em;
        text-align: center;
        width: 70%;
    }

    .b-slip {
        position:sticky;
        z-index: 3;
        right: 0;
        bottom: 3%;
        left: 0;
        visibility: @(BetSlip.PreBets.Count > 0 ? "visible" : "hidden");
    }

    .e-grid .e-spinner-pane {
        display: none;
    }

    .e-toast-container .e-toast {
        background-color: rgba(0,0,0, .9);
        border: 1px solid white;
        border-radius: 10px;
        backdrop-filter: blur(10px);
    }

        .e-toast-container .e-toast:hover {
            background-color: rgba(0,0,0, .9);
        }

        .e-toast-container .e-toast .e-toast-message .e-toast-title {
            color: white;
            font-weight: 700;
        }

        .e-toast-container .e-toast .e-toast-message .e-toast-content {
            color: white;
            font-weight: 700;
        }
</style>

@code {

    [CascadingParameter]
    public Task<AuthenticationState> AuthenticationStateTask { get; set; }

    [CascadingParameter]
    public CascadingBetSlipState BetSlip { get; set; }

    #region Toast

    public SfToast ToastObj;
    int time = 60000;
    private ToastEffect ShowAnimation = ToastEffect.FadeIn;
    private ToastEffect HideAnimation = ToastEffect.FadeOut;
    private string Content => $"Thank you for choosing Bet Book.";

    #endregion

    #region Fields

    private bool betSlipVisible;
    private bool isBusy;
    private UserModel loggedInUser;
    private int week;
    private SeasonType season;

    #endregion

    #region Collections

    private GameDto[] games;

    #endregion

    #region OnInitializedAsync

    protected override async Task OnInitializedAsync()
    {
        isBusy = true;
        season = DateTime.Now.CalculateSeason();
        week = season.CalculateWeek(DateTime.Now);
        games = await gameService.GetGamesByWeek(season, week);
        isBusy = false;
        await LoadAndVerifyUser();
    }

    #endregion

    #region Other Methods

    private async Task ShowToast()
    {
        await ToastObj.ShowAsync();
    }

    private async Task LoadAndVerifyUser()
    {
        var authState = await AuthenticationStateTask;
        string objectId = authState.User.Claims.FirstOrDefault(c => c.Type.Contains("objectidentifier"))?.Value;
        loggedInUser = await userData.GetCurrentUserFromAuthentication(objectId) ?? new();

        if (string.IsNullOrWhiteSpace(objectId)) return;

        string firstName = authState.User.Claims.FirstOrDefault(c => c.Type.Contains("givenname"))?.Value;
        string lastName = authState.User.Claims.FirstOrDefault(c => c.Type.Contains("surname"))?.Value;
        string displayName = authState.User.Claims.FirstOrDefault(c => c.Type.Equals("name"))?.Value;
        string emailAddress = authState.User.Claims.FirstOrDefault(c => c.Type.Contains("email"))?.Value;

        bool isDirty = false;

        if (!objectId.Equals(loggedInUser.ObjectIdentifier))
        {
            isDirty = true;
            loggedInUser.ObjectIdentifier = objectId;
        }

        if (!firstName.Equals(loggedInUser.FirstName))
        {
            isDirty = true;
            loggedInUser.FirstName = firstName;
        }

        if (!lastName.Equals(loggedInUser.LastName))
        {
            isDirty = true;
            loggedInUser.LastName = lastName;
        }

        if (!displayName.Equals(loggedInUser.DisplayName))
        {
            isDirty = true;
            loggedInUser.DisplayName = displayName;
        }

        if (!emailAddress.Equals(loggedInUser.EmailAddress))
        {
            isDirty = true;
            loggedInUser.EmailAddress = emailAddress;
        }

        if (isDirty)
        {
            if (string.IsNullOrWhiteSpace(loggedInUser.UserId))
            {
                loggedInUser.AccountBalance = 10000;

                await userData.CreateUser(loggedInUser);
                return;
            }

            await userData.UpdateUser(loggedInUser);
        }
    }

    #endregion

}
